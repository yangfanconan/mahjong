# 麻将规则数据结构设计文档

## 概述

本文档定义麻将规则编辑器的完整数据结构，支持全球各类麻将规则的配置化描述。

## 版本

- 当前版本：1.0.0
- 数据格式：JSON

## 核心结构

```typescript
interface Rule {
  // 基础信息
  id: string;                    // 规则唯一标识
  mingCheng: string;             // 规则名称
  miaoShu: string;               // 规则描述
  fenLei: string;                // 分类：mainstream|dongbei|local|custom
  
  // 牌池配置
  paiChi: PaiChiConfig;
  
  // 对局规则
  duiJuGuiZe: DuiJuRules;
  
  // 动作规则
  dongZuoGuiZe: ActionRules;
  
  // 胡牌条件
  huPaiTiaoJian: HuPaiConditions;
  
  // 番型配置
  fanXing: string[];             // 启用的番型 ID 列表
  
  // 计分规则
  jiFenGuiZe: ScoreRules;
  
  // 东北特色规则
  dongBeiTeShu: DongBeiSpecial;
}
```

## 详细定义

### 1. 牌池配置 (PaiChiConfig)

```typescript
interface PaiChiConfig {
  zongPaiShu: number;            // 总牌数：108|136|144
  
  paiZhongLei: {
    wan: TileTypeConfig;         // 万子
    tiao: TileTypeConfig;        // 条子
    tong: TileTypeConfig;        // 筒子
    feng: TileTypeConfig;        // 风牌
    jian: TileTypeConfig;        // 箭牌
    hua: TileTypeConfig;         // 花牌
  };
  
  laizi: {
    qiYong: boolean;             // 是否启用百搭牌
    laiziPai: Tile[];            // 百搭牌列表
    laiziGuiZe: {
      keChi: boolean;            // 可吃
      kePeng: boolean;           // 可碰
      keGang: boolean;           // 可杠
      jiRuHuPai: boolean;        // 计入胡牌
    };
  };
}

interface TileTypeConfig {
  shiYong: boolean;              // 是否使用
  zhangShu: number;              // 每种张数 (默认 4)
  dianShu: number[];             // 点数列表
}

interface Tile {
  hua: string;                   // 花色：wan|tiao|tong|feng|jian|hua
  dian: number;                  // 点数
}
```

### 2. 对局规则 (DuiJuRules)

```typescript
interface DuiJuRules {
  zhuangJiaGuiZe: {
    chanShengFangShi: string;    // zhizi|lunzhuang|yingjia|dingzhuang
    zhuangJiaFanBei: boolean;    // 庄家翻倍
    zhuangJiaTeQuan: string[];   // 特权列表
    lianZhuang: boolean;         // 连庄
    yingJiaZuoZhuang: boolean;   // 赢家坐庄
  };
  
  moPaiGuiZe: {
    moPaiShunXu: string;         // niShiZhen|shunShiZhen
    moPaiShuLiang: number;       // 起手牌数
  };
  
  chuPaiGuiZe: {
    chuPaiXianZhi: string[];     // 出牌限制
    jinZhiChuYaoJiu: boolean;    // 禁止出幺九
    chuPaiBiBao: boolean;        // 出牌必报
  };
  
  liuJuGuiZe: {
    liuJuTiaoJian: string;       // paiMoWan|shengyu|noHu
    paiQiangShengYu: number;     // 牌墙剩余张数
    huangZhuang: boolean;        // 荒庄
    chaBaoMen: boolean;          // 查苞米
    chaPai: boolean;             // 查牌
    chaJiao: boolean;            // 查叫
    liuJuJiFen: string;          // buBian|zhaoChang
    xueZhanDaoDi: boolean;       // 血战到底
  };
}
```

### 3. 动作规则 (ActionRules)

```typescript
interface ActionRules {
  chi: {
    yunXu: boolean;              // 是否允许吃
    tiaoJian: string;            // any|jia|menqian
    jinZhiChi: boolean;          // 禁止吃
    jinJiaChi: boolean;          // 必须吃夹
    jinBianChi: boolean;         // 禁止吃边
  };
  
  peng: {
    yunXu: boolean;              // 是否允许碰
    qiangPeng: boolean;          // 抢碰优先
    pengPaiBiChu: boolean;       // 碰牌必出
    fanBei: number;              // 碰牌倍数
  };
  
  gang: {
    yunXu: boolean;              // 是否允许杠
    leiXing: {
      mingGang: boolean;         // 明杠
      anGang: boolean;           // 暗杠
      jiaGang: boolean;          // 加杠
      qiangGang: boolean;        // 抢杠
    };
    gangShangKaiHua: boolean;    // 杠上开花
    gangShangPao: boolean;       // 杠上炮
    gangKaiJiaFen: number;       // 杠开加分
    gangHuaFanBei: number;       // 杠花倍数
  };
  
  tingPai: {
    yunXu: boolean;              // 是否允许听牌
    tiShi: boolean;              // 听牌提示
    tingPaiJiangLi: number;      // 听牌奖励
    tingPaiChengFa: number;      // 听牌惩罚
    biMenTingFanBei: number;     // 闭门听倍数
  };
  
  huPaiYouXianJi: {
    qiangGangHu: number;         // 抢杠胡优先级
    gangShangPao: number;        // 杠上炮优先级
    ziMo: number;                // 自摸优先级
    dianPao: number;             // 点炮优先级
  };
  
  jiaHu: boolean;                // 是否允许截胡
  yiPaoDuoXiang: boolean;        // 一炮多响
}
```

### 4. 胡牌条件 (HuPaiConditions)

```typescript
interface HuPaiConditions {
  jiBenXing: string;             // 4zu1jiang|qidui|both
  
  xuYaoJiangPai: boolean;        // 需要将牌
  
  menQing: {
    xuYao: boolean;              // 必须门清
    fanBei: number;              // 门清倍数
  };
  
  queMen: {
    xuYao: boolean;              // 必须缺一门
    menShu: number;              // 缺几门
  };
  
  teShuXing: {
    qiDui: boolean;              // 支持七对
    shiSanYao: boolean;          // 支持十三幺
    pengPengHu: boolean;         // 支持碰碰胡
    qingYiSe: boolean;           // 支持清一色
    hunYiSe: boolean;            // 支持混一色
  };
  
  teShuHuPai: {
    tianHu: { yunXu: boolean; fanShu: number; };
    diHu: { yunXu: boolean; fanShu: number; };
    renHu: { yunXu: boolean; fanShu: number; };
    guanGangHu: { yunXu: boolean; fanShu: number; };
  };
  
  fanShuMenKan: number;          // 番数门槛
}
```

### 5. 计分规则 (ScoreRules)

```typescript
interface ScoreRules {
  jiFenFangShi: string;          // fanShu|dou|fen
  
  diFen: number;                 // 底分
  
  fanShuJiSuan: string;          // chengFa|jiaFa
  
  zhuangJiaJiFen: {
    jiaCheng: number;            // 庄家加成倍数
    ziMoQuanBu: boolean;         // 自摸全包
  };
  
  ziMoJiFen: string;             // sanJiaGeFu|jiaFeng
  
  dianPaoJiFen: string;          // danJiaFu
  
  gangPaiJiFen: {
    mingGang: number;            // 明杠分数
    anGang: number;              // 暗杠分数
    shouFuFangShi: string;       // dianGangZheFu|sanJiaFu
  };
  
  fengDing: {
    qiYong: boolean;             // 启用封顶
    zuiDaFen: number;            // 最大分数
    fengDingFanXing: string[];   // 不封顶番型
  };
}
```

### 6. 东北特色 (DongBeiSpecial)

```typescript
interface DongBeiSpecial {
  baoPai: {
    qiYong: boolean;             // 启用宝牌
    chanShengFangShi: string;    // moPaiHou|moPaiQian|gangHou
    baoPaiShuLiang: number;      // 宝牌数量
    baoPaiZuoYong: string;       // baiDa|jiaFen|both
    baoZhongBao: {
      qiYong: boolean;           // 启用宝中宝
      fanBei: number;            // 宝中宝倍数
    };
  };
  
  biMen: {
    qiYong: boolean;             // 启用闭门规则
    biMenFanBei: number;         // 闭门倍数
    kaiMenFanBei: number;        // 开门倍数
    biMenLouHuBuPei: boolean;    // 闭门漏胡不赔
  };
  
  douPai: {
    qiYong: boolean;             // 启用豆牌
    jiSuanFangShi: string;       // fanShu|dou
    zuiDaDouShu: number;         // 最大豆数
  };
  
  louHu: {
    qiYong: boolean;             // 启用漏胡规则
    louHuJinHuDangLun: boolean;  // 漏胡禁胡当轮
    louHuJinHuBenLun: boolean;   // 漏胡禁胡本轮
  };
  
  xiPai: {
    qiYong: boolean;             // 启用喜牌
    xiPaiLeiXing: string[];      // 喜牌类型
  };
}
```

## 番型数据

```typescript
interface FanXing {
  id: string;                    // 番型 ID
  mingCheng: string;             // 番型名称
  fanShu: number;                // 番数
  miaoShu: string;               // 描述
  shiJiaFan?: boolean;           // 是否加番 (叠加计算)
}
```

### 预定义番型列表

| ID | 名称 | 番数 | 说明 |
|---|---|---|---|
| pingHu | 平胡 | 1 | 4 顺子 +1 将牌 |
| qiDui | 七对 | 2 | 7 个对子 |
| longQiDui | 龙七对 | 4 | 七对有 4 张相同 |
| pengPengHu | 碰碰胡 | 2 | 全部刻子 |
| qingYiSe | 清一色 | 4 | 一种花色 |
| hunYiSe | 混一色 | 2 | 花色 + 字牌 |
| shiSanYao | 十三幺 | 16 | 13 幺九牌 |
| ... | ... | ... | ... |

## 示例配置

### 四川麻将配置

```json
{
  "id": "sichuan",
  "mingCheng": "四川麻将",
  "miaoShu": "血战到底，缺一门，108 张牌",
  "fenLei": "mainstream",
  "paiChi": {
    "zongPaiShu": 108,
    "paiZhongLei": {
      "wan": { "shiYong": true, "zhangShu": 4 },
      "tiao": { "shiYong": true, "zhangShu": 4 },
      "tong": { "shiYong": true, "zhangShu": 4 },
      "feng": { "shiYong": false },
      "jian": { "shiYong": false },
      "hua": { "shiYong": false }
    }
  },
  "duiJuGuiZe": {
    "chi": { "yunXu": false },
    "liuJuGuiZe": {
      "chaJiao": true,
      "xueZhanDaoDi": true
    }
  },
  "huPaiTiaoJian": {
    "queMen": { "xuYao": true, "menShu": 1 }
  }
}
```

### 齐齐哈尔麻将配置

```json
{
  "id": "qiqihaer",
  "mingCheng": "齐齐哈尔麻将",
  "miaoShu": "红中百搭，闭门翻倍，禁吃",
  "fenLei": "dongbei",
  "paiChi": {
    "zongPaiShu": 136,
    "laizi": {
      "qiYong": true,
      "laiziPai": [{ "hua": "jian", "dian": 1 }]
    }
  },
  "duiJuGuiZe": {
    "chi": { "yunXu": false }
  },
  "dongBeiTeShu": {
    "biMen": {
      "qiYong": true,
      "biMenFanBei": 2
    },
    "douPai": {
      "qiYong": true,
      "zuiDaDouShu": 8
    }
  }
}
```

## 数据验证规则

### 必填字段
- `id`: 规则唯一标识
- `mingCheng`: 规则名称

### 数值范围
- `zongPaiShu`: 108-144
- `diFen`: >= 1
- `fanShu`: >= 0

### 冲突检测
1. `chi.yunXu=false` 与 `chi.jinJiaChi=true` 冲突
2. `menQing.xuYao=true` 与 `chi.yunXu=true` 警告
3. `fengDing.qiYong=true` 但 `fengDing.zuiDaFen<=0` 错误

## 版本兼容性

| 版本 | 日期 | 说明 |
|---|---|---|
| 1.0.0 | 2024-01 | 初始版本，支持基础规则和东北特色 |

## 存储说明

- 自定义规则存储于浏览器 LocalStorage
- 键名：`mahjong_custom_rules`
- 格式：JSON 数组
- 大小限制：约 5MB

## 扩展接口

规则引擎支持通过以下方式扩展：

1. **自定义番型**：添加到 `fanXing` 数组
2. **特殊规则脚本**：预留 `guiZeJiaoBen` 字段
3. **条件触发器**：预留 `chuFaQi` 字段

---

*本文档会随版本更新而更新*
